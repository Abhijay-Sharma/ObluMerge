{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Proforma Invoice</title>
  <link href="https://bootswatch.com/5/minty/bootstrap.css" rel="stylesheet" id="theme-style">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #0e0e0e, #838383);
      color: #fff;
    }
    .main-container {
      min-height: calc(100vh - 56px);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 20px;
    }
    .card {
      background: #fff;
      color: #000;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 1000px;
      animation: fadeIn 0.8s ease-out;
      overflow-x: auto;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 25px;
      text-align: center;
      background: #222;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .form-section { margin-bottom: 30px; }
    .form-section h3 { margin-bottom: 15px; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    button {
      padding: 8px 14px;
      margin: 5px;
      background: #222;
      color: #fff;
      font-weight: bold;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      transform: scale(1.05);
      color: #222;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .btn-outline-primary {
      padding: 8px 14px;
      margin: 5px;
      background: #222;
      color: #fff;
      font-weight: bold;
      border-radius: 30px;
      border: none;
      cursor: pointer;
    }
    .btn-outline-primary:hover {
      transform: scale(1.05);
      color: #222;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left:0; top:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      color: #000;
      margin: 10% auto;
      padding: 20px;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
    }
    .close { float:right; cursor:pointer; font-size:20px; }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(30px); }
      to { opacity:1; transform: translateY(0); }
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

{% include 'quotations/navigation.html' %}

<div class="main-container">
  <div class="card">

    <h1>Create Proforma Invoice</h1>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post">
      {% csrf_token %}

      <!-- REQUIRED FIXED FIELD -->
      <input type="hidden" name="customer" id="id_customer" value="{% if selected_customer %}{{ selected_customer.id }}{% endif %}">

      <!-- ================= SHOW FORM ERRORS ================= -->
      {% if invoice_form.errors %}
      <div style="background:#ffdddd; padding:10px; border-left:4px solid red; margin-bottom:15px;">
        <strong>Invoice Errors:</strong>
        {{ invoice_form.errors }}
      </div>
      {% endif %}

      {% if formset.non_form_errors %}
      <div style="background:#ffdddd; padding:10px; border-left:4px solid red; margin-bottom:15px;">
        <strong>Item Errors:</strong>
        {{ formset.non_form_errors }}
      </div>
      {% endif %}

      <!-- ================= CUSTOMER SECTION ================= -->
      <div class="form-section">
        <h3>Customer</h3>
        <button type="button" id="select-customer-btn">Select Customer</button>
        <a href="{% url 'create_customer' %}" class="btn-outline-primary">Create</a>
        <p><strong>Selected:</strong>
          <span id="selected-customer-name">
            {% if selected_customer %}
                {{ selected_customer.name }}
            {% else %}
                None
            {% endif %}
        </span>

        </p>

        <input type="hidden" name="customer_name" id="id_customer_name">
        <input type="hidden" name="customer_address" id="id_customer_address">
        <input type="hidden" name="customer_city" id="id_customer_city">
        <input type="hidden" name="customer_state" id="id_customer_state">
        <input type="hidden" name="customer_pincode" id="id_customer_pincode">
        <input type="hidden" name="customer_phone" id="id_customer_phone">
        <input type="hidden" name="customer_email" id="id_customer_email">
      </div>

      <!-- ================= ITEMS SECTION ================= -->
      <div class="form-section">
        <h3>Proforma Items</h3>

        {{ formset.management_form }}

        <div class="table-wrapper">
          <table id="items-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Action</th>
              </tr>
            </thead>

            <tbody>
            {% for form in formset %}

              <!-- SHOW PER-FORM ERRORS -->
              {% if form.errors %}
              <tr>
                <td colspan="3">
                  <div style="background:#fff3cd; padding:8px; border-left:4px solid #ffcc00;">
                    {{ form.errors }}
                  </div>
                </td>
              </tr>
              {% endif %}

              <tr class="item-form">
                <td>
                  <span class="product-label">
                    {% if form.instance.product %}
                      {{ form.instance.product.name }}
                    {% else %}
                      None
                    {% endif %}
                  </span>
                  <button type="button" class="select-product-btn">Select Product</button>
                  {{ form.product }}
                </td>

                <td>{{ form.quantity }}</td>

                <td>
                  {% if forloop.first %}
                    <button type="button" id="add-item">Add</button>
                  {% else %}
                    <button type="button" class="remove-item">Remove</button>
                  {% endif %}
                </td>
              </tr>

            {% endfor %}
            </tbody>

          </table>
        </div>
      </div>

      {% if invoice_form.created_by %}
        {{ invoice_form.created_by }}
      {% endif %}

      <button type="submit">Save Proforma Invoice</button>
    </form>

  </div>
</div>

<!-- CUSTOMER MODAL -->
<div id="customerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Select Customer</h3>
    <select id="modal-customer-select">
      <option value="">-- Select Customer --</option>
      {% for customer in customers %}
      <option value="{{ customer.id }}"
              data-name="{{ customer.name }}"
              data-address="{{ customer.address }}"
              data-city="{{ customer.city }}"
              data-state="{{ customer.state }}"
              data-pincode="{{ customer.pincode }}"
              data-phone="{{ customer.phone }}"
              data-email="{{ customer.email }}">
        {{ customer.name }}
      </option>
      {% endfor %}
    </select><br><br>
    <button id="confirm-customer">Confirm</button>
  </div>
</div>

<!-- PRODUCT MODAL -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Select Product</h3>

    <label>Category</label>
    <select id="category-select">
      <option value="">-- Select Category --</option>
      {% for cat in categories %}
      <option value="{{ cat.id }}">{{ cat.name }}</option>
      {% endfor %}
    </select><br><br>

    <label>Product</label>
    <select id="product-select">
      <option value="">-- Select Product --</option>
    </select><br><br>

    <button id="confirm-product">Confirm</button>
  </div>
</div>

<script>
$(function () {

  /* ================= CUSTOMER MODAL ================= */
  var customerModal = $("#customerModal");
  $("#select-customer-btn").click(() => customerModal.show());
  $("#customerModal .close").click(() => customerModal.hide());

  $("#confirm-customer").click(function () {
    let s = $("#modal-customer-select option:selected");

    if (s.val()) {
      $("#id_customer").val(s.val());  // <-- IMPORTANT
      $("#id_customer_name").val(s.data("name"));
      $("#id_customer_address").val(s.data("address"));
      $("#id_customer_city").val(s.data("city"));
      $("#id_customer_state").val(s.data("state"));
      $("#id_customer_pincode").val(s.data("pincode"));
      $("#id_customer_phone").val(s.data("phone"));
      $("#id_customer_email").val(s.data("email"));
      $("#selected-customer-name").text(s.data("name"));
    }
    customerModal.hide();
  });

  /* ================= PRODUCT MODAL ================= */
  var productModal = $("#productModal");
  var currentProductInput = null;
  var currentProductLabel = null;

  $(document).on("click", ".select-product-btn", function () {
    currentProductInput = $(this).siblings("input[type=hidden]");
    currentProductLabel = $(this).siblings(".product-label");
    productModal.show();
  });

  $("#productModal .close").click(() => productModal.hide());

  $("#category-select").change(function () {
    let categoryId = $(this).val();
    $("#product-select").empty().append('<option value="">-- Select Product --</option>');
    if (categoryId) {
      $.get("{% url 'get_inventory_by_category' %}", { category_id: categoryId }, function (data) {
        data.products.forEach(function (p) {
          $("#product-select").append(`<option value="${p.id}">${p.name}</option>`);
        });
      });
    }
  });

  $("#confirm-product").click(function () {
    let id = $("#product-select").val();
    let name = $("#product-select option:selected").text();
    if (id && currentProductInput) {
      currentProductInput.val(id);
      currentProductLabel.text(name);
    }
    productModal.hide();
  });

  /* ================= ADD/REMOVE ITEMS ================= */
  $("#add-item").click(function () {
    let totalForms = $("#id_form-TOTAL_FORMS");
    let formCount = parseInt(totalForms.val());
    let newForm = $(".item-form:first").clone(true);

    newForm.find("input, select").each(function () {
      let name = $(this).attr("name").replace("-0-", "-" + formCount + "-");
      let id = "id_" + name;
      $(this).attr({ name: name, id: id }).val("");
    });

    newForm.find(".product-label").text("None");
    newForm.find("input[type=hidden]").val("");
    newForm.find("td:last").html('<button type="button" class="remove-item">Remove</button>');

    $("#items-table tbody").append(newForm);
    totalForms.val(formCount + 1);
  });

  $(document).on("click", ".remove-item", function () {
    $(this).closest("tr").remove();
    let totalForms = $("#id_form-TOTAL_FORMS");
    totalForms.val(parseInt(totalForms.val()) - 1);
  });

});
</script>

</body>
</html>
