{% extends 'inventory/base.html' %}
{% load static %}
{% block content %}

<style>

body {
    background: #3a3a3a !important;
}

.container.mt-4 {
    background: none !important;
    padding: 20px;
}

.accordion {
    background-color: #1e1e1e;
    color: white;
    cursor: pointer;
    padding: 15px;
    width: 100%;
    border: none;
    outline: none;
    font-size: 17px;
    border-radius: 10px;
    transition: background 0.3s ease;
    margin-top: 10px;

    display: flex;
    justify-content: space-between;
    align-items: center;
}

.active, .accordion:hover {
    background-color: #333;
}

/* LEFT SIDE */
.left-side {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toggle-arrow {
    font-size: 20px;
    color: white;
    transition: transform 0.2s ease;
}

/* RIGHT SIDE: trend icon */
.category-trend {
    font-size: 18px;
}

.panel {
    padding: 0 18px;
    display: none;
    background-color: #2c2c2c;
    overflow: hidden;
    border-radius: 10px;
    margin-bottom: 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    text-align: center;
    padding: 10px;
    color: white;
}

thead {
    background: #000;
}

tbody tr:nth-child(odd) {
    background: #3a3a3a;
}

tbody tr:nth-child(even) {
    background: #4a4a4a;
}

.trend-up { color: #00ff87; font-weight: 600; }
.trend-down { color: #ff5c5c; font-weight: 600; }
.trend-same { color: #9e9e9e; font-weight: 600; }

.filter-form {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    background: black;
    padding: 12px 20px;
    border-radius: 12px;
    margin-bottom: 25px;
}

/* MOBILE PRODUCT ACCORDION */
.mobile-product-list { display: none; }

@media (max-width: 450px) {
    table { display: none !important; }

    .mobile-product-list {
        display: block !important;
        margin-top: 10px;
    }

    .product-accordion {
        background: #1b1b1b;
        color: white;
        cursor: pointer;
        padding: 12px;
        width: 100%;
        border: none;
        text-align: left;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 15px;

        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .product-panel {
        padding: 12px;
        background: #262626;
        border-radius: 8px;
        display: none;
        margin-bottom: 10px;
    }
}

</style>

<div class="container mt-4">

<h2 class="text-center mb-3" style="color:white;">ðŸ“ˆ Category-Wise Sales Comparison</h2>

<form method="get" class="filter-form">
    <div class="text-center mb-3">
        <input type="text" style="color:black;" id="searchBox" class="form-control"
               placeholder="Search category or product..."
               style="max-width: 400px; margin: 0 auto; border-radius: 8px;">
    </div>

    <label>From:</label>
    <input type="date" name="from" value="{{ from_date|date:'Y-m-d' }}">
    <label>To:</label>
    <input type="date" name="to" value="{{ to_date|date:'Y-m-d' }}">
    <button type="submit" class="btn btn-primary">Filter</button>
</form>


{% for category, items in category_data.items %}

    <button class="accordion" data-category>

        <div class="left-side">
            <span class="toggle-arrow">â–¶</span>
            <span class="category-title">{{ category }}</span>
        </div>

        <span class="category-trend"></span>
    </button>

    <div class="panel">

        {# DESKTOP TABLE #}
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Previous</th>
                    <th>Current</th>
                    <th>Î” Diff</th>
                    <th>% Change</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
            {% for item in items %}
                <tr data-trend="{{ item.trend }}">
                    <td>{{ item.name }}</td>
                    <td>{{ item.previous }}</td>
                    <td>{{ item.current }}</td>
                    <td>{{ item.difference }}</td>
                    <td>
                        {% if item.percent_change != "N/A" %}
                            {{ item.percent_change }}%
                        {% else %}N/A{% endif %}
                    </td>
                    <td>
                        {% if item.trend == "up" %}
                            <span class="trend-up">â–²</span>
                        {% elif item.trend == "down" %}
                            <span class="trend-down">â–¼</span>
                        {% else %}
                            <span class="trend-same">â–¬</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        {# MOBILE PRODUCT ACCORDION #}
        <div class="mobile-product-list">
            {% for item in items %}
                <button class="product-accordion" data-trend="{{ item.trend }}">
                    <span>{{ item.name }}</span>

                    {% if item.trend == "up" %}
                        <span class="trend-up">â–²</span>
                    {% elif item.trend == "down" %}
                        <span class="trend-down">â–¼</span>
                    {% else %}
                        <span class="trend-same">â–¬</span>
                    {% endif %}
                </button>

                <div class="product-panel">
                    <p><b>Previous:</b> {{ item.previous }}</p>
                    <p><b>Current:</b> {{ item.current }}</p>
                    <p><b>Difference:</b> {{ item.difference }}</p>
                    <p><b>% Change:</b>
                        {% if item.percent_change != "N/A" %}
                            {{ item.percent_change }}%
                        {% else %}N/A{% endif %}
                    </p>
                </div>
            {% endfor %}
        </div>

    </div>

{% endfor %}

</div>

<script>

// ============ CATEGORY ACCORDION WITH LEFT ARROW ============
document.querySelectorAll(".accordion").forEach(btn => {
    btn.addEventListener("click", function () {

        const panel = this.nextElementSibling;
        const arrow = this.querySelector(".toggle-arrow");

        const isOpen = panel.style.display === "block";

        // Toggle display
        panel.style.display = isOpen ? "none" : "block";

        // Arrow change â–¶ â†’ â–¼
        arrow.textContent = isOpen ? "â–¶" : "â–¼";

        this.classList.toggle("active");
    });
});


// ============ PRODUCT ACCORDION (MOBILE) ============
document.querySelectorAll(".product-accordion").forEach(btn => {
    btn.addEventListener("click", function () {
        const panel = this.nextElementSibling;
        panel.style.display = panel.style.display === "block" ? "none" : "block";
    });
});


// ============ CATEGORY TREND CALCULATION ============
document.addEventListener("DOMContentLoaded", function () {

    document.querySelectorAll("[data-category]").forEach(categoryHeader => {

        const panel = categoryHeader.nextElementSibling;
        const productElements = panel.querySelectorAll("[data-trend]");

        let up = 0, down = 0, same = 0;

        productElements.forEach(el => {
            const trend = el.getAttribute("data-trend");
            if (trend === "up") up++;
            else if (trend === "down") down++;
            else same++;
        });

        let overall = "same";
        if (up > down && up > same) overall = "up";
        else if (down > up && down > same) overall = "down";

        const iconSpan = categoryHeader.querySelector(".category-trend");

        if (overall === "up") iconSpan.innerHTML = `<span class="trend-up">â–²</span>`;
        else if (overall === "down") iconSpan.innerHTML = `<span class="trend-down">â–¼</span>`;
        else iconSpan.innerHTML = `<span class="trend-same">â–¬</span>`;
    });

});
</script>

{% endblock %}