from django.core.management.base import BaseCommand
from django.core.mail import EmailMultiAlternatives
from django.template.loader import render_to_string
from django.conf import settings
from django.db import models
from inventory.models import Category, InventoryItem
from django.db.models import Prefetch
from django.db.models import Q


class Command(BaseCommand):
    help = "Sends full inventory report email with low-stock highlights"

    def handle(self, *args, **options):
        EXCLUDED_PRODUCT_NAMES = ["3D Motion Display Panel"]
        EXCLUDED_PRODUCT_IDS = [

            2702,
            2707,
            2719,
            2799,
            2802,
            2819,
            2822,
            2829,
            2832,
            2843,
            2851,
            2871,
            2882,
            2885,
            2886,
            2939,
            2940,
            2941,
            2943,
            2947,
            2950,
            2951,
            2952,
            2953,
            2956,
            2957,
            2961,
            2964,
            2966,
            3033,
            3036,
            3144,
            3150,
            3151,
            3156,
            3183,
            3204,
            3216,
            3228,
            3257,
            3295,
            3039,
            3177,
            3178,
            3179,
            3181,
            2697,
            2699,
            2824,
            2942,
            3040,
            3041,
            3042,
            3043,
            3044,
            3190,
            3191,
            2700,
            2701,
            2963,
            2990,
            3045,
            3172,
            2861,
            2862,
            3055,
            2703,
            2704,
            2863,
            2864,
            3046,
            3269,
            2865,
            2705,
            2866,
            2867,
            2868,
            2884,
            3047,
            3050,
            3051,
            3217,
            3232,
            3272,
            2869,
            2889,
            2962,
            3053,
            3054,
            3184,
            3195,
            3239,
            3267,
            3273,
            3147,
            3194,
            2708,
            2709,
            2710,
            2872,
            2874,
            2875,
            2991,
            2992,
            3056,
            3057,
            3058,
            3060,
            3061,
            3062,
            3065,
            3066,
            3067,
            3196,
            2876,
            3059,
            3069,
            2727,
            2737,
            2738,
            2740,
            2742,
            2743,
            2748,
            2749,
            2750,
            2751,
            2753,
            2578,
            2760,
            2763,
            2765,
            2766,
            2767,
            2773,
            2775,
            2777,
            2778,
            2782,
            2786,
            2787,
            2790,
            2796,
            2835,
            2838,
            2912,
            2914,
            2915,
            2916,
            2919,
            2920,
            2920,
            2922,
            2923,
            2924,
            2925,
            2926,
            2928,
            2930,
            2931,
            2980,
            2982,
            3013,
            3016,
            3017,
            3018,
            3019,
            3020,
            3022,
            3023,
            3027,
            3028,
            3029,
            3030,
            3031,
            3063,
            3074,
            3087,
            3105,
            3108,
            3109,
            3110,
            3111,
            3112,
            3113,
            3114,
            3115,
            3116,
            3117,
            3121,
            3119,
            3120,
            3122,
            3123,
            3131,
            3132,
            3133,
            3135,
            3140,
            3175,
            3176,
            3224,
            2389,
            3290,
            2873,
            3064,
            2714,
            2820,
            2833,
            2841,
            2949,
            3034,
            3037,
            3070,
            3080,
            3146,
            3149,
            3153,
            3157,
            3160,
            3161,
            3162,
            3163,
            3165,
            3166,
            3262,
            2716,
            2717,
            2878,
            2879,
            2880,
            2718,
            2881,
            2994,
            2995,
            2996,
            3071,
            3072,
            3073,
            3286,
            2821,
            2855,
            3075,
            3170,
            3174,
            2794,
            3076,
            3078,
            3088,
            3118,
            3124,
            3126,
            3145,
            3148,
            2797,
            2798,
            2800,
            2807,
            2810,
            2811,
            2812,
            2813,
            2814,
            2842,
            2854,
            2856,
            2887,
            2935,
            2936,
            3077,
            3090,
            3136,
            3137,
            3141,
            3142,
            3159,
            2723,
            2817,
            2938,
            3143,
            2834,
            2859,
            2888,
            2965,
            3187,
            3210,
            3211,
            3229,
            3231,
            3265,
            2696,
            2724,
            2725,
            2890,
            2891,
            2997,
            3081,
            3082,
            3083,
            3084,
            3085,
            3086,
            3180,
            3206,
            3221,
            3222,
            3234,
            2892,
            2845,
            2893,
            3212,
            3251,
            3270,
            2728,
            2729,
            2894,
            2906,
            2999,
            3091,
            3092,
            3099,
            3102,
            3252,
            3253,
            3254,
            3260,
            2730,
            2896,
            2897,
            2901,
            2902,
            2903,
            2904,
            2907,
            3005,
            3006,
            3007,
            3093,
            3094,
            3095,
            3097,
            3098,
            3100,
            3101,
            3104,
            3185,
            3197,
            3198,
            3205,
            2898,
            2899,
            2998,
            3000,
            3001,
            3002,
            3003,
            3004,
            3096,
            3103,
            3188,
            3189,
            3287,
            3288,
            2895,
            2908,
            3182,
            3281,
            2909,
            2932,
            2933,
            3134,
            3164,
            3263,
            2860,
            3125,
            3127,
            3130,
            3214,
            3237,
            3138,
            3201,
            3202,
            3225,
            3235,
            3255,
            3292,
            3294,
            3139,
            3139,
            2803,
            2827,
            2828,
            2830,
            2831,
            3035,
            3154,
            3155,
            3226,
            3227,
            3230,
            3186,
            3238,
            3285,
            2958,
            2844,
            3167,
            3168,
            2846,
            2959,
            2858,
            2960,
            3038,
            3169,
            3215,
            3258,
            3282,
            2968,
            3173,
            2969,
            2976,
            2978,
            2979,
            2984,
            2985,
            2986,
            2987,
            3171,
            3192,
            3193,
            3089,
            3207,
            3208,
            3219,
            3220,
            3274,
            3283,
            3209,
            3233,
            3249,
            3293,
            3236,
            3241,
            3242,
            3243,
            3244,
            3245,
            3246,
            3259,
            3266,
            3268,
            3271,
            3291,
            3248,
            3250,
            3256,
            3264,
            3280,
            3261,
            3284,
        ]

        # üßæ Get all categories with related inventory items
        categories = Category.objects.prefetch_related(
            Prefetch(
                'inventoryitem_set',
                queryset=InventoryItem.objects.exclude(
                    Q(id__in=EXCLUDED_PRODUCT_IDS) |
                    Q(name__in=EXCLUDED_PRODUCT_NAMES)
                )
            )
        ).all()

        if not any(c.inventoryitem_set.exists() for c in categories):
            self.stdout.write(self.style.WARNING("‚ö†Ô∏è No inventory items found."))
            return

        # üßÆ Identify low stock items
        low_stock_items = InventoryItem.objects.exclude(
            Q(id__in=EXCLUDED_PRODUCT_IDS) |
            Q(name__in=EXCLUDED_PRODUCT_NAMES)
        ).filter(
            quantity__lt=models.F('min_quantity_outwards')
        )

        # üì¶ Prepare context for email template
        context = {
            "categories": categories,
            "low_stock_items": low_stock_items,
        }

        # üß© Render HTML email content
        html_content = render_to_string('inventory/low_stock_email.html', context)

        # ‚úâÔ∏è Prepare email
        subject = "üìä Daily Inventory Report (Low Stock Alerts Included)"
        from_email = "inventory@oblutools.com"
        to_emails = ["nitin.a@obluhc.com","swasti.obluhc@gmail.com","accounts@obluhc.com","sanyam.obluhc@gmail.com","sujal.obluhc@gmail.com","raman.obluhc@gmail.com","vibhuti.obluhc@gmail.com","abhijay.obluhc@gmail.com"]  # üëà your target email
        # to_emails=["madderladder68@gmail.com","swasti.obluhc@gmail.com","kashish.obluhc@gmail.com"]
        msg = EmailMultiAlternatives(subject, "", from_email, to_emails)
        msg.attach_alternative(html_content, "text/html")
        msg.send()

        self.stdout.write(self.style.SUCCESS("‚úÖ Inventory report email sent to madderladder68@gmail.com"))
