<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salesperson → Customer Overview</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

:root{
  --page-bg: #000;
  --card-bg: #111;
  --table-header: #000;
  --row-hover: #1a1a1a;
  --accordion-closed: #600000;
  --accordion-open: #222222;
  --text-light: #ffffff;
  --border-light: #aa0000;
  --active-green: #00c851;
  --inactive-red: #ff4444;
}

body{
  background: var(--page-bg);
  font-family: "Poppins", sans-serif;
  color: var(--text-light);
}

/* ------------------------------------------------------
    MAIN PAGE CARD
------------------------------------------------------ */
.center-card {
  max-width: 640px;
  margin: 72px auto;
  padding: 30px;
  border-radius: 16px;
  background: var(--card-bg);
  box-shadow: 0 0 25px rgba(255,0,0,0.15);
}

/* ------------------------------------------------------
    SEARCH + SUGGESTIONS
------------------------------------------------------ */
.search-wrapper { position: relative; }

#customerSearch {
  border-radius: 25px;
  border: 1px solid #444;
  background: gray;
  height: 44px;
}

.suggestions {
  position: absolute;
  left: 0;
  right: 0;
  top: calc(100% + 6px);
  background: #111;
  border-radius: 12px;
  border: 1px solid #333;
  box-shadow: 0 0 18px rgba(255,0,0,0.15);
  max-height: 260px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.suggestions .item {
  padding: 12px 16px;
  cursor: pointer;
  color: white;
  border-bottom: 1px solid #2a2a2a;
}
.suggestions .item:hover {
  background: #222;
}

/* ------------------------------------------------------
     STATS CARDS
------------------------------------------------------ */
.stat-card {
  background: #111;
  color: white;
  border: 1px solid #333;
  border-radius: 14px;
  text-align: center;
}

/* ------------------------------------------------------
      TABLE
------------------------------------------------------ */
.table thead th {
  background: var(--table-header);
  color: white;
  border-color: #333;
}

.table tbody tr {
  background: #1A1A1A !important;
  color: white;
}
.table tbody tr:hover {
  background: var(--row-hover);
}

.accordion-btn {
    background: #111 !important;
    color: #fff;
}

.accordion-btn.active {
    background: #222222;
    color: #fff;
    border: 1px solid #000;
}

.accordion-btn.inactive {
    background: #7a0000 !important;
    border: 1px solid #b30000;
}

.accordion-btn.inactive.active {
    background: #222222 !important;
    border: 1px solid #000;
}

/* PANEL styling */
.accordion-panel {
    background: #111;          /* match theme */
    border: 1px solid #333;
    color: #fff;
}


.badge-active { background: var(--active-green); }
.badge-inactive { background: var(--inactive-red); }

.btn {
  color:#fff;
  background: #111;
  border: #fff 2px solid;
  border-radius: 20px !important;
}

/* ------------------------------------------------------
      MOBILE ACCORDION STYLING — MATCHING YOUR SS
------------------------------------------------------ */
.mobile-accordion .accordion-btn {
  width: 100%;
  padding: 16px;
  font-weight: 600;
  color: white;
  background: var(--accordion-closed);
  border-radius: 12px;
  border: 1px solid var(--border-light);
  position: relative;
  cursor: pointer;
  margin-bottom: 10px;
  transition: 0.25s ease-in-out;
}

.mobile-accordion .accordion-btn .arrow {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  color: white;
  transition: 0.25s;
}

.mobile-accordion .accordion-btn.active {
  background: var(--accordion-open);
  border-color: black;
}

.mobile-accordion .accordion-btn.active .arrow {
  transform: translateY(-50%) rotate(180deg);
}

.accordion-panel {
  display: none;
  background: #111;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 14px;
  margin-top: -5px;
  margin-bottom: 12px;
  color: white;
}

/* ------------------------------------------------------
      DESKTOP HIDE / MOBILE HIDE
------------------------------------------------------ */
@media (max-width: 767px) {
  .desktop-table { display: none !important; }
}

@media (min-width: 768px) {
  .mobile-accordion { display: none !important; }
}

/* ------------------------------------------------------
      MODAL DARK THEME
------------------------------------------------------ */
.modal-content {
  background: #111;
  color: white;
  border-radius: 15px;
  border: 1px solid #333;
}
</style>
</head>

<body>

<div class="container mt-5 mb-5">

{% if not selected_salesperson %}
<!-- FIRST PAGE -->
<div class="center-card text-center">
  <h3 class="fw-bold mb-3">Admin: Salesperson → Customer Overview</h3>

  <form method="GET">
    <label class="form-label">Select Salesperson</label>
    <select name="salesperson" class="form-select mb-3" required>
      <option value="">-- Select --</option>
      {% for s in salespersons %}
      <option value="{{ s.id }}">{{ s.name }}</option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-danger w-100">Continue →</button>
  </form>
</div>

{% else %}

<!-- MAIN PAGE -->
<h2 class="fw-bold mb-4">Customers handled by: {{ selected_salesperson.name }}</h2>

<!-- SEARCH + SELECTOR -->
<div class="card shadow-sm p-4 mb-4" style="background:#111; border:1px solid #333;">
  <form method="GET" class="row g-3 align-items-end">
    <input type="hidden" name="salesperson" value="{{ selected_salesperson.id }}">

    <div class="col-md-4">
      <label class="form-label" style="color:#fff;">Select Salesperson</label>
      <select name="salesperson" class="form-select" onchange="this.form.submit()">
        {% for s in salespersons %}
        <option value="{{ s.id }}" {% if selected_salesperson.id == s.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-5 search-wrapper">
      <label class="form-label" style="color:#fff;">Search Customer</label>
      <input id="customerSearch" class="form-control" placeholder="Search customer..." autocomplete="off" >
      <div id="searchSuggestions" class="suggestions"></div>
    </div>
  </form>
</div>

<!-- STATS -->
<div class="row g-4 mb-4">
  <div class="col-md-4"><div class="stat-card"><h3>Total Customers</h3><h2>{{ customers|length }}</h2></div></div>
  <div class="col-md-4"><div class="stat-card"><h3>Active</h3><h2 class="text-success">{{ active_count }}</h2></div></div>
  <div class="col-md-4"><div class="stat-card"><h3>Inactive</h3><h2 class="text-danger">{{ inactive_count }}</h2></div></div>
</div>

<!-- DESKTOP TABLE -->
<div class="card shadow-sm card-table" style="background:#111; border:1px solid #333;">
  <div class="card-body p-0">
    <table id="customerTable" class="table table-hover mb-0 desktop-table">
      <thead><tr>
        <th>S.No</th><th>Customer</th><th>State</th><th>Total Orders</th>
        <th>Total Value</th><th>Last Order</th><th>Status</th><th>Actions</th>
      </tr></thead>

      <tbody>
        {% for c in customers %}
        <tr
          class="{% if c.is_red_flag %}inactive{% endif %}"
          data-customer-id="{{ c.id }}"
          data-customer-name="{{ c.name }}">


          <td style="background: #1A1A1A; color: #fff;">{{ forloop.counter }}</td>
          <td class="cust-name" style="background: #1A1A1A; color: #fff;">{{ c.name }}</td>
          <td style="background: #1A1A1A; color: #fff;">{{ c.state }}</td>
          <td style="background: #1A1A1A; color: #fff;">{{ c.total_orders }}</td>
          <td style="background: #1A1A1A; color: #fff;">₹ {{ c.total_order_value|floatformat:2 }}</td>
          <td style="background: #1A1A1A; color: #fff;">{{ c.last_order_date|default:"None" }}</td>
          <td style="background: #1A1A1A; color: #fff;">
            {% if c.is_red_flag %}
            <span class="badge badge-inactive">Inactive</span>
            {% else %}
            <span class="badge badge-active">Active</span>
            {% endif %}
          </td>
          <td style="background: #1A1A1A; color: #fff;">
            <a href="{% url 'customer_item_purchases' c.id %}" class="btn btn-outline-danger btn-sm mb-1">View Item Purchases</a>
            <button class="btn btn-danger btn-sm open-history" data-customer="{{ c.id }}">View Order History</button>
          </td>

          <!-- Hidden History -->
          <div id="history-data-{{ c.id }}" style="display:none;">
            <ul>
              {% for v in c.vouchers_list %}
              <li><strong>{{ v.date }}</strong> — {{ v.voucher_type }} {{ v.voucher_number }}</li>
              {% empty %}
              <li>No vouchers found.</li>
              {% endfor %}
            </ul>
          </div>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- MOBILE ACCORDION -->
    <div class="mobile-accordion p-2">
      {% for c in customers %}
    <button
        class="accordion-btn {% if c.is_red_flag %}inactive{% endif %}"
        data-customer-id="{{ c.id }}"
        data-customer-name="{{ c.name }}">

        {{ c.name }}
        <span class="arrow">▼</span>
      </button>

      <div class="accordion-panel">
        <p><strong>State:</strong> {{ c.state }}</p>
        <p><strong>Total Orders:</strong> {{ c.total_orders }}</p>
        <p><strong>Total Value:</strong> ₹ {{ c.total_order_value|floatformat:2 }}</p>
        <p><strong>Last:</strong> {{ c.last_order_date|default:"None" }}</p>

        <p>
          <a href="{% url 'customer_item_purchases' c.id %}" class="btn btn-outline-danger btn-sm mb-1">View Item Purchases</a>
          <button class="btn btn-danger btn-sm open-history" data-customer="{{ c.id }}">View Order History</button>
        </p>

        <div id="history-data-{{ c.id }}" style="display:none;">
          <ul>
          {% for v in c.vouchers_list %}
            <li><strong>{{ v.date }}</strong> — {{ v.voucher_type }} {{ v.voucher_number }}</li>
          {% empty %}
            <li>No vouchers found.</li>
          {% endfor %}
          </ul>
        </div>
      </div>
      {% endfor %}
    </div>

  </div>
</div>

    <!-- ORDER HISTORY MODAL -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order History</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" id="historyModalBody">
        <!-- JS will inject history here -->
      </div>
    </div>
  </div>
</div>


{% endif %}
</div>

  <!-- Bootstrap JS (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // wait for DOM
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('customerSearch');
      const suggestionsBox = document.getElementById('searchSuggestions');
      const table = document.getElementById('customerTable');
      const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];
      const accordButtons = Array.from(document.querySelectorAll('.accordion-btn'));
      const historyModalEl = document.getElementById('historyModal');
      const historyModal = historyModalEl ? new bootstrap.Modal(historyModalEl) : null;
      const historyModalBody = document.getElementById('historyModalBody');

      // build customersIndex using data attributes (more robust)
      const customersIndex = [];

      // From desktop rows
      rows.forEach(r => {
        const id = r.dataset.customerId || r.getAttribute('data-customer-id');
        const name = r.dataset.customerName || (r.querySelector('.cust-name') ? r.querySelector('.cust-name').innerText.trim() : '');
        if (id && name) customersIndex.push({ id: String(id), name: name.trim(), rowEl: r, accBtnEl: null });
      });

      // From mobile accordion buttons
      accordButtons.forEach(btn => {
        const id = btn.dataset.customerId || btn.getAttribute('data-customer-id');
        // prefer the explicit dataset name if present
        const name = btn.dataset.customerName || btn.textContent.replace('▼','').trim();
        // try to find existing by id
        let existing = null;
        if (id) existing = customersIndex.find(c => c.id === String(id));
        if (!existing) existing = customersIndex.find(c => c.name.toLowerCase() === name.toLowerCase());

        if (existing) {
          existing.accBtnEl = btn;
        } else {
          customersIndex.push({ id: id ? String(id) : null, name: name.trim(), rowEl: null, accBtnEl: btn });
        }
      });

      // Helper: render suggestions
      function showSuggestions(list) {
        suggestionsBox.innerHTML = '';
        if (!list || !list.length) { suggestionsBox.style.display = 'none'; suggestionsBox.setAttribute('aria-hidden','true'); return; }

        list.forEach(item => {
          const div = document.createElement('div');
          div.className = 'item';
          div.textContent = item.name;
          div.dataset.cid = item.id;
          div.addEventListener('click', (ev) => {
            ev.stopPropagation();
            selectSuggestion(item);
          });
          suggestionsBox.appendChild(div);
        });

        suggestionsBox.style.display = 'block';
        suggestionsBox.setAttribute('aria-hidden','false');
      }

      // flash highlight (desktop)
      function flashHighlight(el){
        if (!el) return;
        el.classList.add('cust-highlight');
        setTimeout(()=> el.classList.remove('cust-highlight'), 1700);
      }

      // open accordion helper
      function openAccordion(btn) {
        if (!btn) return;
        const panel = btn.nextElementSibling;
        // close others
        document.querySelectorAll('.accordion-btn').forEach(other => {
          if (other !== btn) {
            other.classList.remove('active');
            const p = other.nextElementSibling;
            if (p) p.style.display = 'none';
          }
        });
        // open this
        btn.classList.add('active');
        if (panel) panel.style.display = 'block';
      }

      // scroll & open logic for selected suggestion
      function selectSuggestion(item) {
        suggestionsBox.style.display = 'none';
        searchInput.value = item.name;

        // Desktop row exists -> scroll to it and highlight
        if (item.rowEl) {
          // If the table is inside an overflowed container (card-table), scroll that container first:
          const scrollContainer = item.rowEl.closest('.card-table') || document.scrollingElement || document.documentElement;
          // scroll row into view (works across browsers)
          item.rowEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
          flashHighlight(item.rowEl);
          // If mobile accordion exists too, open it on small screens
          if (item.accBtnEl && window.innerWidth <= 767) {
            openAccordion(item.accBtnEl);
            // also ensure visible in viewport
            item.accBtnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }

        // If only accordion exists (mobile)
        if (item.accBtnEl) {
          // open and scroll
          openAccordion(item.accBtnEl);
          item.accBtnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        // fallback: nothing found visually
        console.warn('selected item has no visual element', item);
      }

      // Search input handlers
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const q = e.target.value.trim().toLowerCase();
          if (!q) { showSuggestions([]); return; }

          // find matches from index
          const matches = customersIndex.filter(c => c.name.toLowerCase().includes(q));
          showSuggestions(matches.slice(0, 50)); // limit to 50 for performance
        });

        // Enter = if exact or first partial match, select it
        searchInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            const q = searchInput.value.trim().toLowerCase();
            if (!q) { showSuggestions([]); return; }
            const exact = customersIndex.find(c => c.name.toLowerCase() === q);
            const partial = customersIndex.find(c => c.name.toLowerCase().includes(q));
            const pick = exact || partial;
            if (pick) selectSuggestion(pick);
          } else if (ev.key === 'ArrowDown') {
            // optional: focus first suggestion
            const first = suggestionsBox.querySelector('.item');
            if (first) first.focus();
          }
        });

        // hide suggestions when clicking outside the search wrapper
        document.addEventListener('click', (ev) => {
          if (!ev.target.closest('.search-wrapper')) {
            suggestionsBox.style.display = 'none';
          }
        });
      }

      // clicking desktop rows highlights them
      rows.forEach(r => {
        r.addEventListener('click', () => flashHighlight(r));
      });

      // Mobile accordion behavior
      document.querySelectorAll('.accordion-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // ignore clicks on the history button inside the panel (stopPropagation used there)
          if (e.target.classList.contains('open-history')) return;
          const panel = btn.nextElementSibling;
          const isOpen = btn.classList.contains('active');

          // close others (optional)
          document.querySelectorAll('.accordion-btn').forEach(other => {
            if (other !== btn) {
              other.classList.remove('active');
              const p = other.nextElementSibling;
              if (p) p.style.display = 'none';
            }
          });

          if (isOpen) {
            btn.classList.remove('active');
            if (panel) panel.style.display = 'none';
          } else {
            btn.classList.add('active');
            if (panel) panel.style.display = 'block';
          }
        });
      });

      // history modal wiring (works for both desktop and mobile)
      document.querySelectorAll('.open-history').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation(); // prevent accordion toggle
          const cid = btn.dataset.customer;
          const template = document.getElementById('history-data-' + cid);
          if (!template) {
            historyModalBody.innerHTML = '<p>No history found.</p>';
          } else {
            historyModalBody.innerHTML = template.innerHTML;
          }
          if (historyModal) historyModal.show();
        });
      });

      // Accessibility: hide suggestions on escape
      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') {
          suggestionsBox.style.display = 'none';
        }
      });

    }); // DOMContentLoaded
  </script>

</body>
</html>