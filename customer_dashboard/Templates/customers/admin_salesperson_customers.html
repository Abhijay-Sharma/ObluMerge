<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salesperson → Customer Overview</title>

<!-- Bootstrap CSS (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --card-bg: #fff;
    --page-bg: #f5f5f5;
    --accent: #222;
    --inactive-red: #d9534f;
    --active-green: #28a745;
  }

  body{
    background: var(--page-bg);
    font-family: "Poppins", sans-serif;
    color: #111;
  }

  /* ========== FIRST CENTER CARD ========== */
  .center-card {
    max-width: 640px;
    margin: 72px auto;
    padding: 30px;
    border-radius: 16px;
    background: var(--card-bg);
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
  }

  /* ========== SEARCH & SUGGESTIONS ========== */
  .search-wrapper { position: relative; }
  #customerSearch {
    border-radius: 24px;
    padding-left: 16px;
    height: 44px;
    font-size: 15px;
  }

  /* Suggestions box positioned under input to avoid overlap with stat cards */
  .suggestions {
    position: absolute;
    left: 0;
    right: 0;
    top: calc(100% + 8px); /* ensures it drops below the input */
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    max-height: 260px;
    overflow-y: auto;
    z-index: 1200;
    display: none;
  }
  .suggestions .item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
  }
  .suggestions .item:hover { background: #f7f7f7; }

  /* ========== STAT CARDS ========== */
  .stat-card { border-radius: 10px; padding: 22px; text-align: center; background: #fff; box-shadow: none; }
  .stat-card h2 { margin: 6px 0; }

  /* ========== TABLE DESKTOP ========== */
  .card-table { overflow-x: auto; }
  .table thead th { background: #222; color: #fff; }
  .cust-highlight { outline: 4px solid rgba(255,193,7,0.18); transition: outline 300ms; }

  /* badges */
  .badge-active { background: var(--active-green); color: #fff; }
  .badge-inactive { background: var(--inactive-red); color: #fff; }

/* ACTION BUTTONS */
    .action-btn {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.25s ease;
        white-space: nowrap;
    }

    /* Buttons */

    .btn{
        border-radius:20px;
    }
  /* ========== MOBILE ACCORDION ========== */
  @media (max-width: 767px) {
    /* hide desktop table */
    .desktop-table { display: none !important; }

    .mobile-accordion .accordion-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      border-radius: 10px;
      border: none;
      background: #fff;
      margin-bottom: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      font-weight: 600;
      cursor: pointer;
      position: relative;
    }

    .accordion-btn .arrow { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); transition: transform .25s; }
    .accordion-btn.active .arrow { transform: translateY(-50%) rotate(180deg); }

    .accordion-panel {
      display: none;
      background: #fff;
      padding: 12px 14px;
      margin-bottom: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .accordion-btn.inactive { background: #fff0f0; border: 1px solid rgba(217,83,79,0.18); color: #6b0000; }
  }

  /* larger screens show table and hide mobile list */
  @media (min-width: 768px) {
    .mobile-accordion { display: none; }
  }

  /* modal styling override */
  .modal-content { border-radius: 12px; }
</style>

</head>
<body>

  <div class="container mt-5 mb-5">

    {% if not selected_salesperson %}
    <!-- FIRST PAGE : SELECT SALES PERSON -->
    <div class="center-card text-center">
      <h3 class="fw-bold mb-3">Admin: Salesperson → Customer Overview</h3>

      <form method="GET">
        <label class="form-label fw-semibold">Select Salesperson</label>
        <select name="salesperson" class="form-select mb-3" required>
          <option value="">-- Select --</option>
          {% for s in salespersons %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>

        <button type="submit" class="btn btn-dark w-100">Continue →</button>
      </form>
    </div>

    {% else %}
    <!-- MAIN PAGE AFTER SELECTION -->
    <h2 class="fw-bold mb-4">Admin: Salesperson → Customer Overview</h2>

    <!-- SEARCH + SELECTOR -->
    <div class="card shadow-sm p-4 mb-4">
      <form method="GET" class="row g-3 align-items-end">
        <input type="hidden" name="salesperson" value="{{ selected_salesperson.id }}">

        <div class="col-md-4">
          <label class="form-label fw-semibold">Select Salesperson</label>
          <select name="salesperson" class="form-select" onchange="this.form.submit()">
            {% for s in salespersons %}
              <option value="{{ s.id }}" {% if selected_salesperson.id == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-5 position-relative search-wrapper">
          <label class="form-label fw-semibold">Search Customer</label>
          <!-- NOTE: we add data-customer-name on accordions / rows below -->
          <input id="customerSearch" class="form-control" placeholder="Search customer..." autocomplete="off" />
          <div id="searchSuggestions" class="suggestions" role="listbox" aria-hidden="true"></div>
        </div>
      </form>
    </div>

    <!-- STATS -->
    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="stat-card card p-3"><h6>Total Customers</h6><h2>{{ customers|length }}</h2></div>
      </div>
      <div class="col-md-4">
        <div class="stat-card card p-3"><h6>Active (Last 90 Days)</h6><h2 class="text-success">{{ active_count }}</h2></div>
      </div>
      <div class="col-md-4">
        <div class="stat-card card p-3"><h6>Inactive</h6><h2 class="text-danger">{{ inactive_count }}</h2></div>
      </div>
    </div>

    <h4 class="fw-bold mb-3">Customers handled by: {{ selected_salesperson.name }}</h4>

    <div class="card shadow-sm mb-4 card-table">
      <div class="card-body p-0">

        <!-- DESKTOP TABLE -->
        <table id="customerTable" class="table table-hover mb-0 desktop-table">
          <thead class="table-dark">
            <tr>
              <th style="width:48px">S.No</th>
              <th>Customer Name</th>
              <th>State</th>
              <th>Total Orders</th>
              <th>Total Order Value</th>
              <th>Last Order Date</th>
              <th>Status</th>
              <th style="width:180px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for c in customers %}
            <!-- add data-customer-id and data-customer-name on the row for robust JS selection -->
            <tr id="cust-row-{{ c.id }}" data-customer-id="{{ c.id }}" data-customer-name="{{ c.name|escape }}" class="{% if c.is_red_flag %}table-danger{% endif %}">
              <td>{{ forloop.counter }}</td>
              <td class="cust-name">{{ c.name }}</td>
              <td>{{ c.state }}</td>
              <td>{{ c.total_orders }}</td>
              <td>₹ {{ c.total_order_value|floatformat:2 }}</td>
              <td>{{ c.last_order_date|default:"None" }}</td>
              <td>
                {% if c.is_red_flag %}
                  <span class="badge badge-inactive">Inactive</span>
                {% else %}
                  <span class="badge badge-active">Active</span>
                {% endif %}
              </td>
              <td>
                <!-- View Item Purchases (link) -->
                <a href="{% url 'customer_item_purchases' c.id %}" class="btn btn-sm btn-outline-dark me-2" style="border-radius: 20px; margin-bottom:5px;">View Item Purchases</a>

                <!-- View Order History (opens modal) -->
                <button type="button" class="btn btn-sm btn-dark open-history" data-customer="{{ c.id }}" style="border-radius: 20px;">View Order History</button>

                <!-- Hidden history template copied to modal when needed -->
                <div id="history-data-{{ c.id }}" style="display:none;">
                  <ul class="list-unstyled mb-0">
                    {% for v in c.vouchers_list %}
                      <li class="py-1"><strong>{{ v.date }}</strong> &mdash; {{ v.voucher_type }} {{ v.voucher_number }}</li>
                    {% empty %}
                      <li class="py-1">No vouchers found.</li>
                    {% endfor %}
                  </ul>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- MOBILE ACCORDION -->
        <div class="mobile-accordion d-md-none p-3">
          {% for c in customers %}
          <div class="mb-2">
            <!-- provide data-customer-id and data-customer-name (escapejs not needed in attribute because Django autoescapes) -->
            <button type="button" class="accordion-btn {% if c.is_red_flag %}inactive{% endif %}" data-customer-id="{{ c.id }}" data-customer-name="{{ c.name|escape }}">
              {{ c.name }}
              <span class="arrow">▼</span>
            </button>

            <div class="accordion-panel">
              <p><strong>State:</strong> {{ c.state }}</p>
              <p><strong>Total Orders:</strong> {{ c.total_orders }}</p>
              <p><strong>Total Order Value:</strong> ₹ {{ c.total_order_value|floatformat:2 }}</p>
              <p><strong>Last Order:</strong> {{ c.last_order_date|default:"None" }}</p>

              <p><strong>Status:</strong>
                {% if c.is_red_flag %}
                  <span class="badge badge-inactive">Inactive</span>
                {% else %}
                  <span class="badge badge-active">Active</span>
                {% endif %}
              </p>

              <p class="mb-1">
                <a href="{% url 'customer_item_purchases' c.id %}" class="btn btn-outline-dark btn-sm me-2">View Item Purchases</a>
                <button type="button" class="btn btn-dark btn-sm open-history" data-customer="{{ c.id }}">View Order History</button>
              </p>

              <!-- Hidden history for modal -->
              <div id="history-data-{{ c.id }}" style="display:none;">
                <ul class="list-unstyled mb-0">
                  {% for v in c.vouchers_list %}
                    <li class="py-1"><strong>{{ v.date }}</strong> &mdash; {{ v.voucher_type }} {{ v.voucher_number }}</li>
                  {% empty %}
                    <li class="py-1">No vouchers found.</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

      </div>
    </div>

    <!-- ORDER HISTORY MODAL -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Order History</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="historyModalBody">
            <!-- filled by JS -->
          </div>
        </div>
      </div>
    </div>

    {% endif %}
  </div>

  <!-- Bootstrap JS (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // wait for DOM
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('customerSearch');
      const suggestionsBox = document.getElementById('searchSuggestions');
      const table = document.getElementById('customerTable');
      const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];
      const accordButtons = Array.from(document.querySelectorAll('.accordion-btn'));
      const historyModalEl = document.getElementById('historyModal');
      const historyModal = historyModalEl ? new bootstrap.Modal(historyModalEl) : null;
      const historyModalBody = document.getElementById('historyModalBody');

      // build customersIndex using data attributes (more robust)
      const customersIndex = [];

      // From desktop rows
      rows.forEach(r => {
        const id = r.dataset.customerId || r.getAttribute('data-customer-id');
        const name = r.dataset.customerName || (r.querySelector('.cust-name') ? r.querySelector('.cust-name').innerText.trim() : '');
        if (id && name) customersIndex.push({ id: String(id), name: name.trim(), rowEl: r, accBtnEl: null });
      });

      // From mobile accordion buttons
      accordButtons.forEach(btn => {
        const id = btn.dataset.customerId || btn.getAttribute('data-customer-id');
        // prefer the explicit dataset name if present
        const name = btn.dataset.customerName || btn.textContent.replace('▼','').trim();
        // try to find existing by id
        let existing = null;
        if (id) existing = customersIndex.find(c => c.id === String(id));
        if (!existing) existing = customersIndex.find(c => c.name.toLowerCase() === name.toLowerCase());

        if (existing) {
          existing.accBtnEl = btn;
        } else {
          customersIndex.push({ id: id ? String(id) : null, name: name.trim(), rowEl: null, accBtnEl: btn });
        }
      });

      // Helper: render suggestions
      function showSuggestions(list) {
        suggestionsBox.innerHTML = '';
        if (!list || !list.length) { suggestionsBox.style.display = 'none'; suggestionsBox.setAttribute('aria-hidden','true'); return; }

        list.forEach(item => {
          const div = document.createElement('div');
          div.className = 'item';
          div.textContent = item.name;
          div.dataset.cid = item.id;
          div.addEventListener('click', (ev) => {
            ev.stopPropagation();
            selectSuggestion(item);
          });
          suggestionsBox.appendChild(div);
        });

        suggestionsBox.style.display = 'block';
        suggestionsBox.setAttribute('aria-hidden','false');
      }

      // flash highlight (desktop)
      function flashHighlight(el){
        if (!el) return;
        el.classList.add('cust-highlight');
        setTimeout(()=> el.classList.remove('cust-highlight'), 1700);
      }

      // open accordion helper
      function openAccordion(btn) {
        if (!btn) return;
        const panel = btn.nextElementSibling;
        // close others
        document.querySelectorAll('.accordion-btn').forEach(other => {
          if (other !== btn) {
            other.classList.remove('active');
            const p = other.nextElementSibling;
            if (p) p.style.display = 'none';
          }
        });
        // open this
        btn.classList.add('active');
        if (panel) panel.style.display = 'block';
      }

      // scroll & open logic for selected suggestion
      function selectSuggestion(item) {
        suggestionsBox.style.display = 'none';
        searchInput.value = item.name;

        // Desktop row exists -> scroll to it and highlight
        if (item.rowEl) {
          // If the table is inside an overflowed container (card-table), scroll that container first:
          const scrollContainer = item.rowEl.closest('.card-table') || document.scrollingElement || document.documentElement;
          // scroll row into view (works across browsers)
          item.rowEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
          flashHighlight(item.rowEl);
          // If mobile accordion exists too, open it on small screens
          if (item.accBtnEl && window.innerWidth <= 767) {
            openAccordion(item.accBtnEl);
            // also ensure visible in viewport
            item.accBtnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }

        // If only accordion exists (mobile)
        if (item.accBtnEl) {
          // open and scroll
          openAccordion(item.accBtnEl);
          item.accBtnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        // fallback: nothing found visually
        console.warn('selected item has no visual element', item);
      }

      // Search input handlers
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const q = e.target.value.trim().toLowerCase();
          if (!q) { showSuggestions([]); return; }

          // find matches from index
          const matches = customersIndex.filter(c => c.name.toLowerCase().includes(q));
          showSuggestions(matches.slice(0, 50)); // limit to 50 for performance
        });

        // Enter = if exact or first partial match, select it
        searchInput.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            const q = searchInput.value.trim().toLowerCase();
            if (!q) { showSuggestions([]); return; }
            const exact = customersIndex.find(c => c.name.toLowerCase() === q);
            const partial = customersIndex.find(c => c.name.toLowerCase().includes(q));
            const pick = exact || partial;
            if (pick) selectSuggestion(pick);
          } else if (ev.key === 'ArrowDown') {
            // optional: focus first suggestion
            const first = suggestionsBox.querySelector('.item');
            if (first) first.focus();
          }
        });

        // hide suggestions when clicking outside the search wrapper
        document.addEventListener('click', (ev) => {
          if (!ev.target.closest('.search-wrapper')) {
            suggestionsBox.style.display = 'none';
          }
        });
      }

      // clicking desktop rows highlights them
      rows.forEach(r => {
        r.addEventListener('click', () => flashHighlight(r));
      });

      // Mobile accordion behavior
      document.querySelectorAll('.accordion-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // ignore clicks on the history button inside the panel (stopPropagation used there)
          if (e.target.classList.contains('open-history')) return;
          const panel = btn.nextElementSibling;
          const isOpen = btn.classList.contains('active');

          // close others (optional)
          document.querySelectorAll('.accordion-btn').forEach(other => {
            if (other !== btn) {
              other.classList.remove('active');
              const p = other.nextElementSibling;
              if (p) p.style.display = 'none';
            }
          });

          if (isOpen) {
            btn.classList.remove('active');
            if (panel) panel.style.display = 'none';
          } else {
            btn.classList.add('active');
            if (panel) panel.style.display = 'block';
          }
        });
      });

      // history modal wiring (works for both desktop and mobile)
      document.querySelectorAll('.open-history').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation(); // prevent accordion toggle
          const cid = btn.dataset.customer;
          const template = document.getElementById('history-data-' + cid);
          if (!template) {
            historyModalBody.innerHTML = '<p>No history found.</p>';
          } else {
            historyModalBody.innerHTML = template.innerHTML;
          }
          if (historyModal) historyModal.show();
        });
      });

      // Accessibility: hide suggestions on escape
      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') {
          suggestionsBox.style.display = 'none';
        }
      });

    }); // DOMContentLoaded
  </script>

</body>
</html>