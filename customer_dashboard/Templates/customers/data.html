{% extends 'customers/base.html' %}
{% block content %}
<h2>ðŸ“‹ Customer Data</h2>

<form method="get" class="row mb-3">
    <div class="col-md-4">
        <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search name..." class="form-control">
    </div>
    <div class="col-md-3">
        <select name="salesperson" class="form-select">
            <option value="">All Salespersons</option>
            {% for s in salespersons %}
            <option value="{{ s }}" {% if request.GET.salesperson == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <select name="state" class="form-select">
            <option value="">All States</option>
            {% for st in states %}
            <option value="{{ st }}" {% if request.GET.state == st %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100">Filter</button>
    </div>
</form>

<table class="table table-striped table-bordered">
    <thead class="table-primary">
        <tr>
            <th>Name</th><th>Email</th><th>Phone</th><th>State</th>
            <th>District</th><th>Address</th><th>Salesperson</th> <th>Last Purchase</th>

        </tr>
    </thead>
    <tbody>
        {% for c in customers %}
        <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.email }}</td>
            <td>{{ c.phone }}</td>
            <td>{{ c.state }}</td>
            <td>{{ c.district }}</td>
            <td>{{ c.address }}</td>
            <td>{{ c.salesperson.name|default:"Unassigned" }}</td>
                    <!--  Last Purchase column -->
            <td>
                {% if c.last_purchase_date %}
                    {{ c.last_purchase_date|date:"d M Y" }}
                    {% if c.last_product_name %}
                        <br>
                        <small class="text-muted">{{ c.last_product_name }}</small>
                    {% endif %}
                {% else %}
                    <span class="text-muted">No Purchase</span>
                {% endif %}
            </td>


        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-center">No customers found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- âœ… Pagination controls -->
{% if is_paginated %}
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">

    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.previous_page_number }}&search={{ request.GET.search|urlencode }}&salesperson={{ request.GET.salesperson|urlencode }}&state={{ request.GET.state|urlencode }}">
           Previous
        </a>
      </li>
    {% endif %}

    {% for num in paginator.page_range %}
      {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
        <li class="page-item {% if num == page_obj.number %}active{% endif %}">
          <a class="page-link"
             href="?page={{ num }}&search={{ request.GET.search|urlencode }}&salesperson={{ request.GET.salesperson|urlencode }}&state={{ request.GET.state|urlencode }}">
             {{ num }}
          </a>
        </li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.next_page_number }}&search={{ request.GET.search|urlencode }}&salesperson={{ request.GET.salesperson|urlencode }}&state={{ request.GET.state|urlencode }}">
           Next
        </a>
      </li>
    {% endif %}

  </ul>
</nav>
{% endif %}

{% endblock %}