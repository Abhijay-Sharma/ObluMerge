<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customers Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #000;
        color: #fff;
        font-family: "Poppins", sans-serif;
    }

    .page-title {
        text-align: center;
        font-family: "Playfair Display", serif;
        font-size: 30px;
        margin-bottom: 15px;
    }

    .manager-filter {
        text-align: center;
        margin-bottom: 20px;
    }

    .manager-filter select {
        padding: 10px 18px;
        border-radius: 25px;
        background: #111;
        color: #fff;
        border: 1px solid #555;
        font-size: 14px;
    }

    .search-wrapper {
        width: 100%;
        max-width: 400px;
        margin: 0 auto 20px;
        position: relative;
    }

    #customerSearch {
        width: 100%;
        padding: 12px 18px;
        border-radius: 30px;
        border: 1px solid #666;
        background: #111;
        color: white;
    }

    .search-suggestions {
        background: #1a1a1a;
        position: absolute;
        width: 100%;
        border-radius: 10px;
        display: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
    }

    .search-suggestions div {
        padding: 10px;
        border-bottom: 1px solid #333;
        cursor: pointer;
    }

    .mobile-list {
        width: 90vw;
        margin: 0 auto;
    }

    .accordion {
        width: 100%;
        background: #1e1e1e;
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        border: none;
        text-align: left;
        font-size: 17px;
        margin-top: 12px;
        cursor: pointer;
        position: relative;
    }

    .accordion.red-flag {
        background: #6b0000;
        border: 1px solid #ff4d4d;
    }

    .accordion::after {
        content: "â–¼";
        position: absolute;
        right: 15px;
        transition: 0.3s;
    }

    .accordion.active::after {
        transform: rotate(180deg);
    }

    .panel {
        display: none;
        background: #2b2b2b;
        padding: 12px;
        border-radius: 10px;
    }

    .last-order-red {
        color: #ff4d4d;
    }

        /* ========== MODAL ========== */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }
    .modal-box {
        background: #fff;
        color: #000;
        padding: 25px;
        border-radius: 10px;
        width: 90%;
        max-width: 450px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-box h2{
        text-align:center;
    }



    .open-history,
    .remark-btn {
        width: 160px;
        height: 40px;
        margin-top: 10px;
        border-radius: 20px;
        border: none;
        color: #fff;
        cursor: pointer;
    }

    .open-history {
        background: linear-gradient(to right, transparent, #222, transparent);
    }

    .remark-btn {
        background: linear-gradient(to right, #007bff, #0044aa);
    }

    .remark-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .remark-box {
        background: #fff;
        color: #000;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 420px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .remark-box textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: none;
    }

    .save-remark {
        margin-top: 12px;
        width: 100%;
        height: 40px;
        border-radius: 20px;
        background: #28a745;
        color: #fff;
        border: none;
        cursor: pointer;
    }

    hr {
        border-color: #ccc;
    }
    .followup-badge {
    background: #ffc107;
    color: #000;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
}
        .followup-badge {
    background: #ffc107;
    color: #000;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
}
/* ------------------------------------------------------
     STATS CARDS (EXACT SAME)
------------------------------------------------------ */
.stat-card {
  background: #111;
  color: white;
  border: 1px solid #333;
  border-radius: 14px;
  text-align: center;
  padding: 20px;
}

.stat-card h3 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 6px;
  opacity: 0.85;
}

.stat-card h2 {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
}
</style>
</head>

<body>

<h1 class="page-title">
    {{ request.user.username }} <br> Customers & Order History
</h1>

{% if is_manager %}
<div class="manager-filter">
    <select id="teamFilter">
        <option value="all" {% if selected_member == "all" %}selected{% endif %}>All Team Customers</option>
        <option value="me" {% if selected_member == "me" %}selected{% endif %}>My Customers</option>
        {% for member in team_members %}
            <option value="{{ member.id }}" {% if selected_member == member.id|stringformat:"s" %}selected{% endif %}>
                {{ member.name }}
            </option>
        {% endfor %}
    </select>
</div>
{% endif %}

<div class="search-wrapper">
    <input id="customerSearch" placeholder="Search customer...">
    <div id="suggestions" class="search-suggestions"></div>
</div>

<!-- STATS -->
<div class="row g-4 mb-4">
  <div class="col-md-4"><div class="stat-card"><h3>Total Customers</h3><h2>{{ customers|length }}</h2></div></div>
  <div class="col-md-4"><div class="stat-card"><h3>Active</h3><h2 class="text-success">{{ active_count }}</h2></div></div>
  <div class="col-md-4"><div class="stat-card"><h3>Inactive</h3><h2 class="text-danger">{{ inactive_count }}</h2></div></div>
</div>

<div class="mobile-list">

{% for customer in customers %}
<button class="accordion {% if customer.is_red_flag %}red-flag{% endif %}">
    {{ customer.name }}
</button>

<div class="panel">

    <!-- âœ… NOTHING REMOVED -->
    <p><strong>Phone:</strong> {{ customer.phone }}</p>
    <p><strong>Address:</strong> {{ customer.address }}</p>
    <p><strong>Total Orders:</strong> {{ customer.total_orders }}</p>
    <p><strong>Total Value:</strong> â‚¹{{ customer.total_order_value }}</p>

    <p class="{% if customer.is_red_flag %}last-order-red{% endif %}">
        <strong>Last Order:</strong>
        {{ customer.last_order_date|default:"No orders yet" }}
    </p>

    <a href="{% url 'customer_item_purchases' customer.id %}">
        View Item Purchases
    </a><br>

    <a href="{% url 'customers:customerpaymentstatus' customer.id %}">
        View Payment Status
    </a><br>

    <button class="open-history" data-customer="{{ customer.id }}">
        View Order History
    </button>

    <!-- âœ… ADD REMARK -->
    <button class="remark-btn" onclick="openRemark('{{ customer.id }}')">
        Add Remark
    </button>

    <!-- âœ… VIEW REMARKS -->
    <button class="remark-btn" onclick="openRemarkList('{{ customer.id }}')">
        View Remarks ({{ customer.remarks_list|length }})
    </button>
    <!-- âœ… ADD FOLLOW-UP -->
    <button class="remark-btn" onclick="openFollowup('{{ customer.id }}')">
        Schedule Follow-Up
    </button>

    <!-- âœ… VIEW FOLLOW-UPS -->
    <button class="remark-btn" onclick="openFollowupList('{{ customer.id }}')">
        Follow-Ups ({{ customer.followups_list|length }})
    </button>

    <!-- âœ… ADD REMARK MODAL -->
    <div class="remark-modal" id="remarkModal{{ customer.id }}">
        <div class="remark-box">
            <h3>Add Remark â€“ {{ customer.name }}</h3>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <textarea name="remark" required></textarea>
                <button type="submit" class="save-remark">Save Remark</button>
            </form>
        </div>
    </div>
    <!-- âœ… ADD FOLLOW-UP MODAL -->
    <div class="remark-modal" id="followupModal{{ customer.id }}">
        <div class="remark-box">
            <h3>Schedule Follow-Up â€“ {{ customer.name }}</h3>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="followup_customer_id" value="{{ customer.id }}">

                <label>Follow-up Date</label>
                <input type="date"
                       name="followup_date"
                       required
                       style="width:100%; padding:8px; margin-bottom:10px;">

                <label>Note</label>
                <textarea name="followup_note"
                          placeholder="Optional note..."></textarea>

                <button type="submit" class="save-remark">
                    Save Follow-Up
                </button>
            </form>
        </div>
    </div>


    <!-- âœ… VIEW REMARKS MODAL -->
    <div class="remark-modal" id="remarkList{{ customer.id }}">
        <div class="remark-box">
            <h3>Remarks â€“ {{ customer.name }}</h3>

            {% for r in customer.remarks_list %}
                <p>{{ r.remark }}</p>
                <small>{{ r.salesperson }} | {{ r.created_at }}</small>

                {% if r.salesperson.user == request.user %}
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="delete_remark_id" value="{{ r.id }}">
                    <button type="submit" style="border:none;background:none;color:red;cursor:pointer;">
                        ðŸ—‘
                    </button>
                </form>
                {% endif %}
                <hr>
            {% empty %}
                <p>No remarks yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- âœ… VIEW FOLLOW-UPS MODAL -->
    <div class="remark-modal" id="followupList{{ customer.id }}">
        <div class="remark-box">
            <h3>Follow-Ups â€“ {{ customer.name }}</h3>

            {% for f in customer.followups_list %}
                <p>
                    ðŸ“… <strong>{{ f.followup_date }}</strong>
                    {% if f.is_completed %}
                        <span style="color:green;">(Completed)</span>
                    {% endif %}
                </p>

                {% if f.note %}
                    <p>{{ f.note }}</p>
                {% endif %}

                <!-- âœ… COMPLETE BUTTON -->
                {% if not f.is_completed %}
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="complete_followup_id" value="{{ f.id }}">
                    <button type="submit"
                            style="border:none;background:none;color:green;cursor:pointer;">
                        âœ” Complete
                    </button>
                </form>
                {% endif %}

                <!-- âœ… DELETE BUTTON -->
                <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="delete_followup_id" value="{{ f.id }}">
                    <button type="submit"
                            style="border:none;background:none;color:red;cursor:pointer;">
                        ðŸ—‘ Delete
                    </button>
                </form>

                <hr>
            {% empty %}
                <p>No follow-ups scheduled.</p>
            {% endfor %}
        </div>
    </div>


    <div class="history-data" id="history-{{ customer.id }}" style="display:none;">
        <ul>
            {% for v in customer.vouchers_list %}
                <li>{{ v.date }} â€” {{ v.voucher_type }} {{ v.voucher_number }}</li>
            {% empty %}
                <li>No vouchers found.</li>
            {% endfor %}
        </ul>
    </div>
        <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box">
            <h2>Order History</h2>
            <div id="modalContent"></div>
        </div>
    </div>


</div>
{% endfor %}

</div>

<script>
document.querySelectorAll(".accordion").forEach(btn => {
    btn.addEventListener("click", () => {
        btn.classList.toggle("active");
        const panel = btn.nextElementSibling;
        panel.style.display = panel.style.display === "block" ? "none" : "block";
    });
});



function openRemark(id) {
    document.getElementById("remarkModal" + id).style.display = "flex";
}

function openRemarkList(id) {
    document.getElementById("remarkList" + id).style.display = "flex";
}
function openFollowup(id) {
    document.getElementById("followupModal" + id).style.display = "flex";
}

function openFollowupList(id) {
    document.getElementById("followupList" + id).style.display = "flex";
}
document.querySelectorAll(".remark-modal").forEach(modal => {
    modal.addEventListener("click", e => {
        if (e.target === modal) modal.style.display = "none";
    });
});

    /* Modal */
        document.querySelectorAll(".open-history").forEach(btn => {
            btn.addEventListener("click", e => {
                e.stopPropagation();
                const id = btn.dataset.customer;
                document.getElementById("modalContent").innerHTML =
                    document.getElementById("history-" + id).innerHTML;
                document.getElementById("modalContent").innerHTML =
                    document.getElementById("history-" + id).innerHTML;

                document.getElementById("modalOverlay").style.display = "flex";
            });
        });
        document.getElementById("modalOverlay").addEventListener("click", () => {
            document.getElementById("modalOverlay").style.display = "none";
        });

    /* Search */
    const searchInput = document.getElementById("customerSearch");
    const suggestions = document.getElementById("suggestions");
    const accordions = document.querySelectorAll(".accordion");

    searchInput.addEventListener("input", () => {
        const value = searchInput.value.toLowerCase();
        suggestions.innerHTML = "";

        if (!value) {
            suggestions.style.display = "none";
            return;
        }

        accordions.forEach((acc, index) => {
            const name = acc.textContent.trim().toLowerCase();
            if (name.includes(value)) {
                let div = document.createElement("div");
                div.textContent = acc.textContent.trim();

                div.onclick = () => {
                    suggestions.style.display = "none";
                    searchInput.value = div.textContent;

                    acc.scrollIntoView({behavior:"smooth", block:"center"});
                    acc.classList.add("active");
                    acc.nextElementSibling.style.display = "block";
                };

                suggestions.appendChild(div);
            }
        });

        suggestions.style.display = "block";
    });



const teamFilter = document.getElementById("teamFilter");
if (teamFilter) {
    teamFilter.addEventListener("change", function () {
        const params = new URLSearchParams(window.location.search);
        params.set("team_member", this.value);
        window.location.search = params.toString();
    });
}
</script>

</body>
</html>