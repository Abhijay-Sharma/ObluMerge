<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customers Dashboard</title>

<style>
    body {
        background: #000;
        color: #fff;
        font-family: "Poppins", sans-serif;
    }

    .page-title {
        text-align: center;
        font-family: "Playfair Display", serif;
        font-size: 30px;
        margin-bottom: 15px;
    }

    /* ===== MANAGER DROPDOWN (NEW, SAFE) ===== */
    .manager-filter {
        text-align: center;
        margin-bottom: 20px;
    }

    .manager-filter select {
        padding: 10px 18px;
        border-radius: 25px;
        background: #111;
        color: #fff;
        border: 1px solid #555;
        font-size: 14px;
    }

    /* ===== SEARCH ===== */
    .search-wrapper {
        width: 100%;
        max-width: 400px;
        margin: 0 auto 20px;
        position: relative;
    }

    #customerSearch {
        width: 100%;
        padding: 12px 18px;
        border-radius: 30px;
        border: 1px solid #666;
        background: #111;
        color: white;
    }

    .search-suggestions {
        background: #1a1a1a;
        position: absolute;
        width: 100%;
        border-radius: 10px;
        display: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
    }

    .search-suggestions div {
        padding: 10px;
        border-bottom: 1px solid #333;
        cursor: pointer;
    }

    /* ===== ACCORDION ===== */
    .mobile-list {
        width: 90vw;
        margin: 0 auto;
    }

    .accordion {
        width: 100%;
        background: #1e1e1e;
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        border: none;
        text-align: left;
        font-size: 17px;
        margin-top: 12px;
        cursor: pointer;
        position: relative;
    }

    .accordion.red-flag {
        background: #6b0000;
        border: 1px solid #ff4d4d;
    }

    .accordion::after {
        content: "▼";
        position: absolute;
        right: 15px;
        transition: 0.3s;
    }

    .accordion.active::after {
        transform: rotate(180deg);
    }

    .panel {
        display: none;
        background: #2b2b2b;
        padding: 12px;
        border-radius: 10px;
    }

    .last-order-red {
        color: #ff4d4d;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    .modal-box {
        background: #fff;
        color: #000;
        padding: 25px;
        border-radius: 10px;
        width: 90%;
        max-width: 450px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .open-history {
        width: 140px;
        height: 40px;
        color: #fff;
        border-radius: 20px;
        background: linear-gradient(to right, transparent, #222, transparent);
        margin-top: 10px;
    }
</style>
</head>

<body>

<!-- ===== PAGE TITLE (UNCHANGED) ===== -->
<h1 class="page-title">
    {{ request.user.username }} <br> Customers & Order History
</h1>

<!-- ===== MANAGER DROPDOWN (NEW, SAFE ADDITION) ===== -->
{% if is_manager %}
<div class="manager-filter">
    <select id="teamFilter">
        <option value="all" {% if selected_member == "all" %}selected{% endif %}>
            All Team Customers
        </option>
        <option value="me" {% if selected_member == "me" %}selected{% endif %}>
            My Customers
        </option>
        {% for member in team_members %}
            <option value="{{ member.id }}"
                {% if selected_member == member.id|stringformat:"s" %}selected{% endif %}>
                {{ member.name }}
            </option>
        {% endfor %}
    </select>
</div>
{% endif %}

<!-- ===== SEARCH (UNCHANGED) ===== -->
<div class="search-wrapper">
    <input id="customerSearch" placeholder="Search customer...">
    <div id="suggestions" class="search-suggestions"></div>
</div>

<!-- ===== CUSTOMER LIST (UNCHANGED) ===== -->
<div class="mobile-list">

{% for customer in customers %}
    <button class="accordion {% if customer.is_red_flag %}red-flag{% endif %}">
        {{ customer.name }}
    </button>

    <div class="panel">
        <p><strong>Phone:</strong> {{ customer.phone }}</p>
        <p><strong>Address:</strong> {{ customer.address }}</p>
        <p><strong>Total Orders:</strong> {{ customer.total_orders }}</p>
        <p><strong>Total Value:</strong> ₹{{ customer.total_order_value }}</p>

        <p class="{% if customer.is_red_flag %}last-order-red{% endif %}">
            <strong>Last Order:</strong>
            {% if customer.last_order_date %}
                {{ customer.last_order_date }}
            {% else %}
                No orders yet
            {% endif %}
        </p>

        <a href="{% url 'customer_item_purchases' customer.id %}">
            View Item Purchases
        </a>

        <button class="open-history" data-customer="{{ customer.id }}">
            View Order History
        </button>

        <div class="history-data" id="history-{{ customer.id }}" style="display:none;">
            <ul>
                {% for v in customer.vouchers_list %}
                    <li>{{ v.date }} — {{ v.voucher_type }} {{ v.voucher_number }}</li>
                {% empty %}
                    <li>No vouchers found.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
{% endfor %}

</div>

<!-- ===== MODAL (UNCHANGED) ===== -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box">
        <h2>Order History</h2>
        <div id="modalContent"></div>
    </div>
</div>

<script>
    /* Accordion Toggle */
    document.querySelectorAll(".accordion").forEach(btn => {
        btn.addEventListener("click", () => {
            btn.classList.toggle("active");
            const panel = btn.nextElementSibling;
            panel.style.display = panel.style.display === "block" ? "none" : "block";
        });
    });

    /* Modal */
    document.querySelectorAll(".open-history").forEach(btn => {
        btn.addEventListener("click", e => {
            e.stopPropagation();
            const id = btn.dataset.customer;
            document.getElementById("modalContent").innerHTML =
                document.getElementById("history-" + id).innerHTML;
            document.getElementById("modalOverlay").style.display = "flex";
        });
    });

    document.getElementById("modalOverlay").addEventListener("click", () => {
        document.getElementById("modalOverlay").style.display = "none";
    });

    /* Search (UNCHANGED) */
    const searchInput = document.getElementById("customerSearch");
    const suggestions = document.getElementById("suggestions");
    const accordions = document.querySelectorAll(".accordion");

    searchInput.addEventListener("input", () => {
        const value = searchInput.value.toLowerCase();
        suggestions.innerHTML = "";
        if (!value) {
            suggestions.style.display = "none";
            return;
        }
        accordions.forEach(acc => {
            const name = acc.textContent.trim().toLowerCase();
            if (name.includes(value)) {
                let div = document.createElement("div");
                div.textContent = acc.textContent.trim();
                div.onclick = () => {
                    suggestions.style.display = "none";
                    searchInput.value = div.textContent;
                    acc.scrollIntoView({ behavior: "smooth", block: "center" });
                    acc.classList.add("active");
                    acc.nextElementSibling.style.display = "block";
                };
                suggestions.appendChild(div);
            }
        });
        suggestions.style.display = "block";
    });

    /* ===== MANAGER DROPDOWN JS (NEW, SAFE) ===== */
    const teamFilter = document.getElementById("teamFilter");
    if (teamFilter) {
        teamFilter.addEventListener("change", function () {
            const params = new URLSearchParams(window.location.search);
            params.set("team_member", this.value);
            window.location.search = params.toString();
        });
    }
</script>

</body>
</html>