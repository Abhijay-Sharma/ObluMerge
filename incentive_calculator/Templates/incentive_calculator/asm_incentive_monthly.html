<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ASM Monthly Incentive Calculator</title>

<style>
body { background:#000; color:white; font-family:Poppins,sans-serif; padding:25px; }
.card { background:#111; border:1px solid #333; border-radius:12px; padding:20px; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; }
th, td { padding:10px; border-bottom:1px solid #333; }

tr.unpaid { background:#2a0000; }
tr.partial { background:#2a1a00; }

.product-green { color:#00ff99; font-weight:600; }
.product-yellow { color:#ffd54d; font-weight:600; }

.badge { font-size:11px; padding:4px 8px; border-radius:6px; margin-left:5px; }
.badge.red { background:#ff4d4d; }
.badge.orange { background:#ffb84d; color:black; }

a { color:#00ff99; }
</style>
</head>

<body>

<h2>ASM Incentive Calculator — Monthly</h2>

<!-- FILTER -->
<div class="card">
<form method="get">

    <select name="salesperson" required>
        <option value="">-- Select Salesperson --</option>
        {% for sp in salespersons %}
        <option value="{{ sp.id }}"
            {% if selected_salesperson and sp.id == selected_salesperson.id %}selected{% endif %}>
            {{ sp.name }}
        </option>
        {% endfor %}
    </select>

    <!-- ✅ MONTH CALENDAR PICKER -->
    <input type="month" name="month_picker"
           value="{{ year }}-{% if month < 10 %}0{{ month }}{% else %}{{ month }}{% endif %}"
           required>

    <button type="submit">Calculate</button>
</form>
</div>


{% if rows %}
<div class="card">
<h3>Sales Rows</h3>

<table>
<thead>
<tr>
<th>Date</th><th>Customer</th><th>Voucher</th><th>Product</th><th>Qty</th><th>Amount</th>
</tr>
</thead>
<tbody>

{% for r in rows %}
<tr class="{% if r.is_unpaid %}unpaid{% elif r.is_partially_paid %}partial{% endif %}">
<td>{{ r.date }}</td>

<td>
    {% if r.customer_id %}
        <a href="{% url 'customers:customerpaymentstatus' r.customer_id %}">
            {{ r.customer }}
        </a>
    {% else %}
        {{ r.customer }}
    {% endif %}

    {% if r.is_unpaid %}
        <span class="badge red">UNPAID</span>
    {% elif r.is_partially_paid %}
        <span class="badge orange">PARTIAL</span>
    {% endif %}
</td>

<td>
    <a href="{% url 'voucher_detail' r.voucher_id %}" target="_blank" style="color:#fff;text-decoration:underline;">
        {{ r.voucher_no }}
    </a>
</td>

<td>
    <span class="{% if r.has_incentive %}product-green{% else %}product-yellow{% endif %}">
        {{ r.product }}
    </span>
</td>

<td>{{ r.quantity }}</td>
<td>₹{{ r.amount }}</td>
</tr>
{% endfor %}

<tr style="font-weight:bold;border-top:2px solid #555;">
<td colspan="5" style="text-align:right;">TOTAL</td>
<td>₹{{ total_sales }}</td>
</tr>

</tbody>
</table>
</div>
{% endif %}

{% if product_totals %}
<div class="card">
<h3>Product-wise Incentive</h3>

<p>
Dynamic Group Paid Qty: <b>{{ dynamic_group_qty }}</b><br>
Dynamic Rate Used:
<b>
{% if dynamic_rate_used is not None %}
₹{{ dynamic_rate_used }}
{% else %}
Base Rates
{% endif %}
</b>
</p>

<table>
<thead>
<tr>
<th>Product</th><th>Paid Qty</th><th>Rate</th><th>Incentive</th>
</tr>
</thead>
<tbody>
{% for product, data in product_totals.items %}
<tr>
<td>{{ product }}</td>
<td>{{ data.paid_qty }}</td>
<td>₹{{ data.rate }}</td>
<td>₹{{ data.incentive }}</td>
</tr>
{% endfor %}
</tbody>
</table>

<h3 style="margin-top:15px;">
Grand Total Incentive: ₹{{ grand_total_incentive }}
</h3>
</div>
{% endif %}

</body>
</html>
