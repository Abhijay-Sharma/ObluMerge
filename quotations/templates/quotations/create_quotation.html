{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Quotation</title>
  <link href="https://bootswatch.com/5/minty/bootstrap.css" rel="stylesheet" id="theme-style">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
* { box-sizing: border-box; margin:0; padding:0; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
  background: linear-gradient(135deg, #0e0e0e, #838383);
  color: #fff;
}

/* Main container */
.main-container {
  min-height: calc(100vh - 56px);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 40px 20px;
}

/* Card */
.card {
  background: #fff;
  color: #000;
  padding: 40px 30px;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  width: 100%;
  max-width: 1000px;
  animation: fadeIn 0.8s ease-out;
  overflow-x: auto; /* allows table to scroll horizontally */
}

/* Headings */
h1 {
  font-size: 2rem;
  margin-bottom: 25px;
  text-align: center;
  background: #222;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.form-section { margin-bottom: 30px; }
.form-section h3 { margin-bottom: 15px; }

/* Inputs */
input[type="text"], input[type="number"], select, textarea {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
}

/* Table */
.table-wrapper {
  width: 100%;
  overflow-x: auto; /* horizontal scroll on small screens */
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: unset; /* remove forced min-width */
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
  white-space: normal; /* allow wrapping */
}
th { background: #eee; }

/* Buttons */
button {
  padding: 8px 14px;
  margin: 5px;
  background: #222;
  color: #fff;
  font-weight: bold;
  border-radius: 30px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}
button:hover {
  transform: scale(1.05);
  color: #222;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

/* Modal */
.modal { display: none; position: fixed; z-index: 999; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.5); }
.modal-content {
  background: #fff;
  color: #000;
  margin: 10% auto;
  padding: 20px;
  border-radius: 16px;
  width: 90%;
  max-width: 450px;
}
.close { float:right; cursor:pointer; font-size:20px; }

.product-label { font-weight: 600; margin-right: 10px; }

@keyframes fadeIn {
  from { opacity:0; transform: translateY(30px); }
  to { opacity:1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 900px) {
  .card { padding: 20px; }
  h1 { font-size: 1.6rem; }
}

@media (max-width: 600px) {
  .card { padding: 15px; }
  h1 { font-size: 1.4rem; }
  table { min-width: 500px; }
  input, select { font-size: 14px; }
  button { padding: 6px 10px; font-size: 14px; }
}
 /* Mobile layout */
@media (max-width: 600px) {
  table, thead, tbody, th, td, tr { display: block; }
  thead { display: none; }

  .item-form {
    width: 95%;
    padding:95%;
    border: 1px solid #ccc;
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 12px;
    background: #f9f9f9;
    color: #000;
  }

  .item-form td {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 6px 0;
    border: none;
  }

  .item-form td::before {
    content: attr(data-label);
    font-weight: bold;
    margin-bottom: 4px;
  }

  .item-form td input,
  .item-form td select,
  .item-form td button {
    width: 100%;
    margin: 0 0 8px 0;
  }

  .item-form td:last-child button {
    margin-bottom: 0;
  }
}

</style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  {% include 'quotations/navigation.html' %}

  <div class="main-container">
    <div class="card">
      <h1>Create Quotation</h1>

      <form method="post">
        {% csrf_token %}

        <!-- Customer Section -->
        <div class="form-section">
          <h3>Customer</h3>
          <button type="button" id="select-customer-btn">Select Customer</button>
          <p><strong>Selected:</strong> <span id="selected-customer-name">None</span></p>

          <!-- Hidden fields -->
          <input type="hidden" name="customer_name" id="id_customer_name">
          <input type="hidden" name="customer_address" id="id_customer_address">
          <input type="hidden" name="customer_city" id="id_customer_city">
          <input type="hidden" name="customer_state" id="id_customer_state">
          <input type="hidden" name="customer_pincode" id="id_customer_pincode">
          <input type="hidden" name="customer_mobile" id="id_customer_mobile">
          <input type="hidden" name="customer_email" id="id_customer_email">
        </div>

        <!-- Quotation Items -->
        <div class="form-section">
          <h3>Quotation Items</h3>
          {{ formset.management_form }}
          <div class="table-wrapper">
            <table id="items-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Qty</th>
                  {% if request.user.is_accountant %}
                    <th>Discount</th>
                  {% endif %}
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
              {% for form in formset %}
                <tr class="item-form">
                  <td>
                    <span class="product-label">None</span>
                    <button type="button" class="select-product-btn">Select Product</button>
                    {{ form.product }}
                  </td>
                  <td data-label="Quantity">{{ form.quantity }}</td>
                  {% if request.user.is_accountant %}
                    <td data-label="Discount">{{ form.discount }}</td>
                  {% endif %}
                  <td data-label="Action">
                    {% if forloop.first %}
                      <button type="button" id="add-item">Add</button>
                    {% else %}
                      <button type="button" class="remove-item">Remove</button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        {% if quotation_form.created_by %}
          {{ quotation_form.created_by }}
        {% endif %}

        <button type="submit">Save Quotation</button>
      </form>
    </div>
  </div>

  <!-- Customer Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Customer</h3>
      <select id="modal-customer-select">
        <option value="">-- Select Customer --</option>
        {% for customer in customers %}
          <option value="{{ customer.id }}"
                  data-name="{{ customer.name }}"
                  data-address="{{ customer.address }}"
                  data-city="{{ customer.city }}"
                  data-state="{{ customer.state }}"
                  data-pincode="{{ customer.pin_code }}"
                  data-mobile="{{ customer.phone }}"
                  data-email="{{ customer.email }}">
            {{ customer.name }}
          </option>
        {% endfor %}
      </select>
      <br><br>
      <button id="confirm-customer">Confirm</button>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Product</h3>
      <label>Category</label>
      <select id="category-select">
        <option value="">-- Select Category --</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}">{{ cat.name }}</option>
        {% endfor %}
      </select>
      <br><br>
      <label>Product</label>
      <select id="product-select">
        <option value="">-- Select Product --</option>
      </select>
      <br><br>
      <button id="confirm-product">Confirm</button>
    </div>
  </div>

<script>
$(function () {
  // ===== Customer Modal =====
  var customerModal = $("#customerModal");
  $("#select-customer-btn").click(() => customerModal.show());
  $("#customerModal .close").click(() => customerModal.hide());

  $("#confirm-customer").click(function () {
    let selected = $("#modal-customer-select option:selected");
    if (selected.val()) {
      $("#id_customer_name").val(selected.data("name"));
      $("#id_customer_address").val(selected.data("address"));
      $("#id_customer_city").val(selected.data("city"));
      $("#id_customer_state").val(selected.data("state"));
      $("#id_customer_pincode").val(selected.data("pincode"));
      $("#id_customer_mobile").val(selected.data("mobile"));
      $("#id_customer_email").val(selected.data("email"));

      $("#selected-customer-name").text(selected.data("name"));
    }
    customerModal.hide();
  });

  // ===== Product Modal =====
  var productModal = $("#productModal");
  var currentProductInput = null;
  var currentProductLabel = null;

  $(document).on("click", ".select-product-btn", function () {
    currentProductInput = $(this).siblings("input[type=hidden]");
    currentProductLabel = $(this).siblings(".product-label");
    productModal.show();
  });
  $("#productModal .close").click(() => productModal.hide());

  $("#category-select").change(function () {
    let categoryId = $(this).val();
    $("#product-select").empty().append('<option value="">-- Select Product --</option>');
    if (categoryId) {
      $.get("{% url 'get_products_by_category' %}", { category_id: categoryId }, function (data) {
        data.products.forEach(function (p) {
          $("#product-select").append(`<option value="${p.id}">${p.name}</option>`);
        });
      });
    }
  });

  $("#confirm-product").click(function () {
    let productId = $("#product-select").val();
    let productName = $("#product-select option:selected").text();
    if (productId && currentProductInput) {
      currentProductInput.val(productId);
      currentProductLabel.text(productName);
    }
    productModal.hide();
  });

  // ===== Add/Remove Items =====
  $("#add-item").click(function () {
    let totalForms = $("#id_form-TOTAL_FORMS");
    let formCount = parseInt(totalForms.val());

    let newForm = $(".item-form:first").clone(true);
    newForm.find("input, select").each(function () {
      let name = $(this).attr("name").replace("-0-", "-" + formCount + "-");
      let id = "id_" + name;
      $(this).attr({ name: name, id: id }).val("");
    });
    newForm.find(".product-label").text("None");
    newForm.find("input[type=hidden]").val("");
    newForm.find("td:last").html('<button type="button" class="remove-item">Remove</button>');

    $("#items-table tbody").append(newForm);
    totalForms.val(formCount + 1);
  });

  $(document).on("click", ".remove-item", function () {
    $(this).closest("tr").remove();
  });
});
</script>

</body>
</html>
