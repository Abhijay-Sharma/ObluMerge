{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Quotation</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .form-section { margin-bottom: 30px; }
    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 8px;
      width: 400px; max-height: 80%; overflow-y: auto;
    }
    .close { float: right; cursor: pointer; font-size: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f8f8f8; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Create Quotation</h2>

  <form method="post">
    {% csrf_token %}

    <!-- ✅ Quotation Fields -->
    <div class="form-section">
      <h3>Customer</h3>
      <p><strong>Selected:</strong> <span id="selected-customer-name">None</span></p>
      <button type="button" id="openCustomerModal">Select Customer</button>

      <!-- Hidden fields to store customer info -->
      <input type="hidden" name="customer_name" id="id_customer_name">
      <input type="hidden" name="customer_address" id="id_customer_address">
      <input type="hidden" name="customer_city" id="id_customer_city">
      <input type="hidden" name="customer_state" id="id_customer_state">
      <input type="hidden" name="customer_pincode" id="id_customer_pincode">
      <input type="hidden" name="customer_mobile" id="id_customer_mobile">
      <input type="hidden" name="customer_email" id="id_customer_email">

      {{ quotation_form.created_by }}
    </div>

    <!-- ✅ Quotation Items -->
    <div class="form-section">
      <h3>Quotation Items</h3>
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Discount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="items-table">
          {% for form in formset %}
            <tr>
              <td>
                <span class="product-name">None</span>
                <button type="button" class="select-product">Select Product</button>
                {{ form.product }}
              </td>
              <td>{{ form.quantity }}</td>
              <td>{{ form.discount }}</td>
              <td>
                {% if form.instance.pk %}
                  <input type="checkbox" name="{{ form.prefix }}-DELETE"> Delete
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {{ formset.management_form }}
    </div>

    <button type="submit">Save Quotation</button>
  </form>

  <!-- ✅ Customer Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Customer</h3>

      <label>Customer</label>
      <select id="modal-customer-select">
        <option value="">-- Select Customer --</option>
        {% for customer in customers %}
          <option value="{{ customer.id }}"
                  data-name="{{ customer.name }}"
                  data-address="{{ customer.address }}"
                  data-city="{{ customer.city }}"
                  data-state="{{ customer.state }}"
                  data-pincode="{{ customer.pin_code }}"
                  data-mobile="{{ customer.phone }}"
                  data-email="{{ customer.email }}">
            {{ customer.name }}
          </option>
        {% endfor %}
      </select>

      <br><br>
      <button id="confirm-customer">Confirm</button>
    </div>
  </div>

  <!-- ✅ Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Product</h3>

      <label>Category</label>
      <select id="category-select">
        <option value="">-- Select Category --</option>
        {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
        {% endfor %}
      </select>

      <label>Product</label>
      <select id="product-select">
        <option value="">-- Select Product --</option>
      </select>

      <br><br>
      <button id="confirm-product">Confirm</button>
    </div>
  </div>

  <script>
    let currentProductField = null;

    // Open customer modal
    $("#openCustomerModal").click(function() {
      $("#customerModal").show();
    });

    // Confirm customer
    $("#confirm-customer").click(function() {
      const selected = $("#modal-customer-select option:selected");
      if (selected.val()) {
        $("#selected-customer-name").text(selected.data("name"));

        // Fill hidden fields
        $("#id_customer_name").val(selected.data("name"));
        $("#id_customer_address").val(selected.data("address"));
        $("#id_customer_city").val(selected.data("city"));
        $("#id_customer_state").val(selected.data("state"));
        $("#id_customer_pincode").val(selected.data("pincode"));
        $("#id_customer_mobile").val(selected.data("mobile"));
        $("#id_customer_email").val(selected.data("email"));
      }
      $("#customerModal").hide();
    });

    // Open product modal
    $(document).on("click", ".select-product", function() {
      currentProductField = $(this).siblings("input[type=hidden]");
      $("#productModal").show();
    });

    // Fetch products by category
    $("#category-select").change(function() {
      const categoryId = $(this).val();
      if (categoryId) {
        $.getJSON("{% url 'get_products' %}?category_id=" + categoryId, function(data) {
          let options = '<option value="">-- Select Product --</option>';
          data.forEach(p => {
            options += `<option value="${p.id}">${p.name}</option>`;
          });
          $("#product-select").html(options);
        });
      } else {
        $("#product-select").html('<option value="">-- Select Product --</option>');
      }
    });

    // Confirm product
    $("#confirm-product").click(function() {
      const selected = $("#product-select option:selected");
      if (selected.val() && currentProductField) {
        currentProductField.val(selected.val());
        currentProductField.closest("td").find(".product-name").text(selected.text());
      }
      $("#productModal").hide();
    });

    // Close modals
    $(".close").click(function() {
      $(this).closest(".modal").hide();
    });
  </script>
</body>
</html>
