{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Quotation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { color: #333; }
    .form-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 400px; }
    .close { float: right; cursor: pointer; font-size: 20px; }
    button { padding: 8px 14px; margin: 5px 0; border: none; border-radius: 4px; background: #007BFF; color: #fff; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h1>Create Quotation</h1>

  <form method="post">
    {% csrf_token %}

    <div class="form-section">
      <h3>Customer</h3>
      <button type="button" id="select-customer-btn">Select Customer</button>
      <p><strong>Selected:</strong> <span id="selected-customer-name">None</span></p>

      <!-- Hidden fields filled on confirm -->
      <input type="hidden" name="customer_name" id="id_customer_name">
      <input type="hidden" name="customer_address" id="id_customer_address">
      <input type="hidden" name="customer_city" id="id_customer_city">
      <input type="hidden" name="customer_state" id="id_customer_state">
      <input type="hidden" name="customer_pincode" id="id_customer_pincode">
      <input type="hidden" name="customer_mobile" id="id_customer_mobile">
      <input type="hidden" name="customer_email" id="id_customer_email">
    </div>

    <div class="form-section">
      <h3>Quotation Items</h3>
      {{ formset.management_form }}
      <table id="items-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Discount</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
        {% for form in formset %}
          <tr class="item-form">
            <td>
              <span class="product-label">None</span>
              <button type="button" class="select-product-btn">Select Product</button>
              {{ form.product }}
            </td>
            <td>{{ form.quantity }}</td>
            <td>{{ form.discount }}</td>
            <td>
              {% if forloop.first %}
                <button type="button" id="add-item">Add</button>
              {% else %}
                <button type="button" class="remove-item">Remove</button>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% if quotation_form.created_by %}
      {{ quotation_form.created_by }}
    {% endif %}

    <button type="submit">Save Quotation</button>
  </form>

  <!-- ✅ Customer Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Customer</h3>
      <select id="modal-customer-select">
        <option value="">-- Select Customer --</option>
        {% for customer in customers %}
          <option value="{{ customer.id }}"
                  data-name="{{ customer.name }}"
                  data-address="{{ customer.address }}"
                  data-city="{{ customer.city }}"
                  data-state="{{ customer.state }}"
                  data-pincode="{{ customer.pin_code }}"
                  data-mobile="{{ customer.phone }}"
                  data-email="{{ customer.email }}">
            {{ customer.name }}
          </option>
        {% endfor %}
      </select>
      <br><br>
      <button id="confirm-customer">Confirm</button>
    </div>
  </div>

  <!-- ✅ Product Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Select Product</h3>

      <label>Category</label>
      <select id="category-select">
        <option value="">-- Select Category --</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}">{{ cat.name }}</option>
        {% endfor %}
      </select>

      <br><br>
      <label>Product</label>
      <select id="product-select">
        <option value="">-- Select Product --</option>
      </select>

      <br><br>
      <button id="confirm-product">Confirm</button>
    </div>
  </div>

<script>
$(function () {
  // ===== Customer Modal =====
  var customerModal = $("#customerModal");
  $("#select-customer-btn").click(() => customerModal.show());
  $("#customerModal .close").click(() => customerModal.hide());

  $("#confirm-customer").click(function () {
    let selected = $("#modal-customer-select option:selected");
    if (selected.val()) {
      $("#id_customer_name").val(selected.data("name"));
      $("#id_customer_address").val(selected.data("address"));
      $("#id_customer_city").val(selected.data("city"));
      $("#id_customer_state").val(selected.data("state"));
      $("#id_customer_pincode").val(selected.data("pincode"));
      $("#id_customer_mobile").val(selected.data("mobile"));
      $("#id_customer_email").val(selected.data("email"));

      $("#selected-customer-name").text(selected.data("name"));
    }
    customerModal.hide();
  });

  // ===== Product Modal =====
  var productModal = $("#productModal");
  var currentProductInput = null;
  var currentProductLabel = null;

  $(document).on("click", ".select-product-btn", function () {
    currentProductInput = $(this).siblings("input[type=hidden]");
    currentProductLabel = $(this).siblings(".product-label");
    productModal.show();
  });
  $("#productModal .close").click(() => productModal.hide());

  $("#category-select").change(function () {
    let categoryId = $(this).val();
    $("#product-select").empty().append('<option value="">-- Select Product --</option>');
    if (categoryId) {
      $.get("{% url 'get_products_by_category' %}", { category_id: categoryId }, function (data) {
        data.products.forEach(function (p) {
          $("#product-select").append(`<option value="${p.id}">${p.name}</option>`);
        });
      });
    }
  });

  $("#confirm-product").click(function () {
    let productId = $("#product-select").val();
    let productName = $("#product-select option:selected").text();
    if (productId && currentProductInput) {
      currentProductInput.val(productId);
      currentProductLabel.text(productName);
    }
    productModal.hide();
  });

  // ===== Add/Remove Items =====
  $("#add-item").click(function () {
    let totalForms = $("#id_form-TOTAL_FORMS");
    let formCount = parseInt(totalForms.val());

    let newForm = $(".item-form:first").clone(true);
    newForm.find("input, select").each(function () {
      let name = $(this).attr("name").replace("-0-", "-" + formCount + "-");
      let id = "id_" + name;
      $(this).attr({ name: name, id: id }).val("");
    });
    newForm.find(".product-label").text("None");
    newForm.find("input[type=hidden]").val("");
    newForm.find("td:last").html('<button type="button" class="remove-item">Remove</button>');

    $("#items-table tbody").append(newForm);
    totalForms.val(formCount + 1);
  });

  $(document).on("click", ".remove-item", function () {
    $(this).closest("tr").remove();
  });
});
</script>
</body>
</html>
